#!/usr/bin/env ansible-playbook
---
- import_playbook: playbooks/10_services.yml

- name: Set up host for nebensinn site
  hosts: site
  gather_facts: no

  tasks:
    - name: install packages for unattended upgrades and email
      apt:
        name:
          - unattended-upgrades
          - apt-listchanges
          - needrestart
          - mailutils
          - default-dbus-session-bus
          - python3-apt-dbg
          - python3-dbus-dbg
          - eximon4
          - swaks
          - dns-root-data
          - file

    - pause:
        prompt: Please run dpkg-reconfigure exim4-config on the host now

    - pause:
        prompt: Please provide SMTP login data in passwd.client in form *:username:password

    - name: copy user credentials
      copy:
        src: passwd.client
        dest: /etc/exim4

    - name: copy exim variables
      copy:
        src: exim4.conf.localmacros
        dest: /etc/exim4

    - name: allow unqualified domains (e.g. email to root)
      block:
      - lineinfile:
          dest: "/etc/exim4/conf.d/main/02_exim4-config_options"
          regexp: "^#? sender_unqualified_hosts ="
          line: " sender_unqualified_hosts = *"
        notify: restart exim
      - lineinfile:
          dest: "/etc/exim4/conf.d/main/02_exim4-config_options"
          regexp: "^#? recipient_unqualified_hosts ="
          line: " recipient_unqualified_hosts = *"
        notify: restart exim

    - name: ensure exim4 is reloaded if need be
      meta: flush_handlers

    - name: send test email
      mail:
        subject: Test email from Ansible

    - pause:
        prompt: Please check if the test email arrived.

    - name: configure installation of all upgrades
      lineinfile:
        dest: "/etc/apt/apt.conf.d/50unattended-upgrades"
        regexp: '^(//)? *"origin=Debian,codename=\${distro_codename}-updates";'
        line: '        "origin=Debian,codename=${distro_codename}-updates";'

    - name: send email on updates
      lineinfile:
        dest: "/etc/apt/apt.conf.d/50unattended-upgrades"
        regexp: '^(//)?Unattended-Upgrade::Mail ".*";'
        line: 'Unattended-Upgrade::Mail "root";'

    - name: automatically remove unused packages
      lineinfile:
        dest: "/etc/apt/apt.conf.d/50unattended-upgrades"
        regexp: '^(//)?Unattended-Upgrade::Remove-Unused-Dependencies ".*";'
        line: 'Unattended-Upgrade::Remove-Unused-Dependencies "true";'

    - name: automatically reboot
      block:
      - lineinfile:
          dest: "/etc/apt/apt.conf.d/50unattended-upgrades"
          regexp: '^(//)?Unattended-Upgrade::Automatic-Reboot ".*";'
          line: 'Unattended-Upgrade::Automatic-Reboot "true";'
      - lineinfile:
          dest: "/etc/apt/apt.conf.d/50unattended-upgrades"
          regexp: '^(//)?Unattended-Upgrade::Automatic-Reboot-Time "02:00";'
          line: 'Unattended-Upgrade::Automatic-Reboot-Time "02:00";'

    - name: test automated upgrades
      command: unattended-upgrade -d

  handlers:
    - name: update exim configuration
      command: update-exim4.conf
      listen: "restart exim"
    - name: restart exim server
      systemd:
        name: exim4
        enabled: yes
        state: restarted
      listen: "restart exim"
